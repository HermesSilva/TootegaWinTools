<?xml version="1.0" encoding="UTF-8"?>
<!--
  SQLiteView Windows Installer Package (WiX 3.x)
  Copyright (c) 1999-2026 Tootega Pesquisa e Inovacao. MIT License.
  
  This installer:
  - Installs SQLiteView.dll to Program Files\Tootega\SQLiteView
  - Registers the COM DLL (shell extension) using regsvr32
  - Requires Administrator elevation (perMachine scope)
  - Supports Install/Uninstall/Repair
  - Detects existing installation and offers appropriate action
-->
<?define ProductName = "SQLiteView" ?>
<?define ProductVersion = "1.0.0" ?>
<?define ProductManufacturer = "Tootega Pesquisa e Inovacao" ?>
<?define UpgradeCode = "034DE3FC-502C-4E3C-B83C-D219F434FC8E" ?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

  <Product Id="*"
           Name="$(var.ProductName)"
           Language="1033"
           Version="$(var.ProductVersion)"
           Manufacturer="$(var.ProductManufacturer)"
           UpgradeCode="$(var.UpgradeCode)">

    <!-- Package attributes - requires elevation -->
    <Package InstallerVersion="500"
             Compressed="yes"
             InstallScope="perMachine"
             Platform="x64"
             Description="SQLiteView - Windows Explorer Shell Extension for SQLite Databases"
             Comments="Browse SQLite databases directly in Windows Explorer"
             Manufacturer="$(var.ProductManufacturer)"
             InstallPrivileges="elevated" />

    <!-- Require Windows 10 x64 -->
    <Condition Message="This application requires Windows 10 or later.">
      <![CDATA[VersionNT >= 603]]>
    </Condition>
    <Condition Message="This application requires a 64-bit version of Windows.">
      <![CDATA[VersionNT64]]>
    </Condition>

    <!-- Media definition -->
    <Media Id="1" Cabinet="SQLiteView.cab" EmbedCab="yes" CompressionLevel="high" />

    <!-- Upgrade handling -->
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed."
                  AllowSameVersionUpgrades="yes"
                  Schedule="afterInstallValidate" />

    <!-- Properties for Add/Remove Programs -->
    <Property Id="ARPPRODUCTICON" Value="ProductIcon" />
    <Property Id="ARPURLINFOABOUT" Value="https://github.com/tootega/SQLiteShell" />
    <Property Id="ARPNOMODIFY" Value="yes" />
    <Property Id="ARPNOREPAIR" Value="no" />
    
    <!-- Icon -->
    <Icon Id="ProductIcon" SourceFile="Resources\database.ico" />

    <!-- ================================================================ -->
    <!-- Directory Structure                                               -->
    <!-- ================================================================ -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="ManufacturerFolder" Name="Tootega">
          <Directory Id="INSTALLFOLDER" Name="SQLiteView" />
        </Directory>
      </Directory>
      <Directory Id="SystemFolder" />
    </Directory>

    <!-- ================================================================ -->
    <!-- Components                                                        -->
    <!-- ================================================================ -->
    <DirectoryRef Id="INSTALLFOLDER">
      
      <!-- Main DLL Component -->
      <Component Id="MainDLL" Guid="9C0D1E2F-3A4B-5C6D-7E8F-9A0B1C2D3E4F" Win64="yes">
        <File Id="SQLiteViewDLL"
              Name="SQLiteView.dll"
              Source="..\x64\Release\SQLiteView.dll"
              KeyPath="yes"
              Vital="yes" />
      </Component>

      <!-- PDB Component (optional) -->
      <Component Id="DebugSymbols" Guid="AC1D2E3F-4B5C-6D7E-8F9A-0B1C2D3E4F5A" Win64="yes">
        <File Id="SQLiteViewPDB"
              Name="SQLiteView.pdb"
              Source="..\x64\Release\SQLiteView.pdb"
              KeyPath="yes" />
      </Component>

    </DirectoryRef>

    <!-- ================================================================ -->
    <!-- Features                                                          -->
    <!-- ================================================================ -->
    <Feature Id="MainFeature"
             Title="SQLiteView Shell Extension"
             Description="Windows Explorer integration for SQLite databases"
             Level="1"
             ConfigurableDirectory="INSTALLFOLDER"
             AllowAdvertise="no"
             Absent="disallow">
      <ComponentRef Id="MainDLL" />
    </Feature>

    <Feature Id="DebugFeature"
             Title="Debug Symbols"
             Description="PDB files for debugging (optional)"
             Level="1000"
             AllowAdvertise="no">
      <ComponentRef Id="DebugSymbols" />
    </Feature>

    <!-- ================================================================ -->
    <!-- Custom Actions for COM Registration                               -->
    <!-- ================================================================ -->

    <!-- Path properties -->
    <Property Id="REGSVR32">
      <DirectorySearch Id="RegSvr32Search" Path="[SystemFolder]">
        <FileSearch Name="regsvr32.exe" />
      </DirectorySearch>
    </Property>

    <!-- Register DLL (Install) -->
    <CustomAction Id="RegisterDLL"
                  Directory="INSTALLFOLDER"
                  ExeCommand="&quot;[SystemFolder]regsvr32.exe&quot; /s &quot;[INSTALLFOLDER]SQLiteView.dll&quot;"
                  Execute="deferred"
                  Impersonate="no"
                  Return="check" />

    <!-- Unregister DLL (Uninstall) -->
    <CustomAction Id="UnregisterDLL"
                  Directory="INSTALLFOLDER"
                  ExeCommand="&quot;[SystemFolder]regsvr32.exe&quot; /u /s &quot;[INSTALLFOLDER]SQLiteView.dll&quot;"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <!-- Stop shell host processes before install/uninstall -->
    <CustomAction Id="StopShellHosts"
                  Directory="SystemFolder"
                  ExeCommand="[SystemFolder]taskkill.exe /F /IM dllhost.exe"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <!-- Stop Explorer -->
    <CustomAction Id="StopExplorer"
                  Directory="SystemFolder"
                  ExeCommand="[SystemFolder]taskkill.exe /F /IM explorer.exe"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <!-- Restart Explorer -->
    <CustomAction Id="StartExplorer"
                  Directory="SystemFolder"
                  ExeCommand="[SystemFolder]cmd.exe /c start /b explorer.exe"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <!-- Set properties for deferred actions -->
    <CustomAction Id="SetStopShellHosts" Property="StopShellHosts" Value="[SystemFolder]" />
    <CustomAction Id="SetStopExplorer" Property="StopExplorer" Value="[SystemFolder]" />
    <CustomAction Id="SetStartExplorer" Property="StartExplorer" Value="[SystemFolder]" />
    <CustomAction Id="SetRegisterDLL" Property="RegisterDLL" Value="[INSTALLFOLDER]" />
    <CustomAction Id="SetUnregisterDLL" Property="UnregisterDLL" Value="[INSTALLFOLDER]" />

    <!-- ================================================================ -->
    <!-- Install/Uninstall Sequence                                        -->
    <!-- ================================================================ -->
    <InstallExecuteSequence>
      <!-- Prepare custom action properties -->
      <Custom Action="SetStopShellHosts" Before="StopShellHosts">NOT UPGRADINGPRODUCTCODE</Custom>
      <Custom Action="SetStopExplorer" Before="StopExplorer">NOT UPGRADINGPRODUCTCODE</Custom>
      <Custom Action="SetStartExplorer" Before="StartExplorer">NOT UPGRADINGPRODUCTCODE</Custom>
      <Custom Action="SetRegisterDLL" Before="RegisterDLL">NOT REMOVE</Custom>
      <Custom Action="SetUnregisterDLL" Before="UnregisterDLL">REMOVE</Custom>

      <!-- Stop processes before file operations -->
      <Custom Action="StopShellHosts" Before="StopExplorer">NOT UPGRADINGPRODUCTCODE</Custom>
      <Custom Action="StopExplorer" Before="InstallFiles">NOT UPGRADINGPRODUCTCODE</Custom>

      <!-- Unregister before removing files -->
      <Custom Action="UnregisterDLL" Before="RemoveFiles">REMOVE="ALL"</Custom>

      <!-- Register after installing files -->
      <Custom Action="RegisterDLL" After="InstallFiles">NOT REMOVE</Custom>

      <!-- Restart Explorer after everything -->
      <Custom Action="StartExplorer" After="InstallFinalize">NOT UPGRADINGPRODUCTCODE</Custom>
    </InstallExecuteSequence>

    <!-- ================================================================ -->
    <!-- User Interface                                                    -->
    <!-- ================================================================ -->
    <UIRef Id="WixUI_Minimal" />
    
    <WixVariable Id="WixUILicenseRtf" Value="Resources\License.rtf" />

    <!-- Exit dialog text -->
    <Property Id="WIXUI_EXITDIALOGOPTIONALTEXT" 
              Value="SQLiteView has been installed successfully. Please restart Windows Explorer or log off/on for changes to take effect." />

  </Product>
</Wix>
